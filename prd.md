# 扣子ID选择功能 PRD

## 需求概述

在现有的2步评估流程基础上，增加"第一步：选择扣子ID"，将原有流程调整为3步：
1. **第一步：选择扣子ID** (新增)
2. **第二步：上传测试问题集** (原第一步)
3. **第三步：执行质量评估** (原第二步)

## 功能分析

### 1. 技术实现分析

#### 1.1 前端实现
- 在主页面增加新的步骤卡片
- 默认显示当前.env中的COZE_BOT_ID
- 提供修改按钮和输入框
- 更新后端API调用，传递选中的扣子ID

#### 1.2 后端实现
- 新增API接口：`/api/coze-bot-id`
  - GET: 获取当前扣子ID
  - PUT: 更新扣子ID到.env文件
- 修改Excel处理逻辑，使用动态扣子ID
- 确保数据库保存时使用正确的扣子ID

#### 1.3 数据流影响分析
当前数据流中扣子ID的使用位置：
1. **Excel处理阶段** (`routes/process-excel.js` → `lib/coze-client.js` → `coze-bot-core.js`)
   - 使用`process.env.COZE_BOT_ID`调用Coze API
2. **数据库保存阶段** (`lib/assessment-storage.js`)
   - 保存会话记录时使用`process.env.COZE_BOT_ID`

**影响评估**：
- ✅ 修改.env文件后，`process.env.COZE_BOT_ID`会立即更新
- ✅ Excel处理和数据库保存都会使用新的扣子ID
- ✅ 不会影响现有的质量评估逻辑

### 2. 界面布局设计

```
┌─────────────────────────────────────────────────────────────┐
│                    🏛️ 苏州科技馆 AI 助手评估平台                    │
│                 自动化测试和评估Coze数字人助手的回复质量              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  [1] 选择扣子ID                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 🤖 当前扣子ID: 7550204987524169763                      │ │
│  │                                                         │ │
│  │ [修改扣子ID]                                            │ │
│  │                                                         │ │
│  │ ┌─ 修改扣子ID弹窗 (点击按钮后显示) ─────────────────────┐ │ │
│  │ │ 请输入新的扣子ID:                                   │ │ │
│  │ │ ┌─────────────────────────────────────────────────┐ │ │ │
│  │ │ │ [输入框]                                        │ │ │ │
│  │ │ └─────────────────────────────────────────────────┘ │ │ │
│  │ │ [确认] [取消]                                       │ │ │
│  │ └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  [2] 上传测试问题集                                          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 上传测试集，自动调用Coze Agent生成回复                   │ │
│  │ [选择Excel文件] [处理Excel]                             │ │
│  │ 进度条...                                               │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  [3] 执行质量评估                                            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 使用LLM对助手回复进行专业评估，生成详细的质量报告        │ │
│  │ [开始评估]                                              │ │
│  │ 进度条...                                               │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3. 交互流程

#### 3.1 初始状态
- 页面加载时显示："已选择扣子ID：7550204987524169763"
- "修改扣子ID"按钮可点击
- 第2、3步保持原有逻辑

#### 3.2 修改扣子ID流程
1. 用户点击"修改扣子ID"按钮
2. 弹出输入框，预填当前扣子ID
3. 用户输入新的扣子ID
4. 点击"确认"：
   - 前端调用API更新扣子ID
   - 更新显示："已选择扣子ID：新ID"
   - 更新.env文件中的COZE_BOT_ID
5. 点击"取消"：关闭弹窗，不做任何更改

#### 3.3 数据一致性保证
- 修改扣子ID后，后续的Excel处理和评估都使用新ID
- 数据库中保存的会话记录包含正确的扣子ID
- 统计分析页面可以按扣子ID筛选数据

## API设计

### 获取当前扣子ID
```
GET /api/coze-bot-id
Response: {
  "success": true,
  "cozeBotId": "7550204987524169763"
}
```

### 更新扣子ID
```
PUT /api/coze-bot-id
Request: {
  "cozeBotId": "新的扣子ID"
}
Response: {
  "success": true,
  "message": "扣子ID更新成功",
  "cozeBotId": "新的扣子ID"
}
```

## 实现优先级

### 高优先级
1. 前端UI调整（步骤重新编号）
2. 扣子ID显示和修改功能
3. 后端API实现
4. .env文件更新逻辑

### 中优先级
1. 数据一致性验证
2. 错误处理和用户提示
3. 输入验证（扣子ID格式）

### 低优先级
1. 扣子ID历史记录
2. 批量扣子ID管理
3. 扣子ID有效性验证

## 风险评估

### 技术风险
- ✅ **低风险**：修改.env文件是安全的，不会影响现有功能
- ✅ **低风险**：数据库保存逻辑已经使用`process.env.COZE_BOT_ID`
- ⚠️ **中风险**：需要确保.env文件写入权限和格式正确性

### 用户体验风险
- ⚠️ **中风险**：用户可能输入无效的扣子ID
- ✅ **低风险**：界面调整不会影响现有用户习惯

## 验收标准

### 功能验收
1. ✅ 页面显示当前扣子ID
2. ✅ 可以修改扣子ID并保存到.env
3. ✅ 修改后的扣子ID在Excel处理中生效
4. ✅ 数据库保存的会话记录包含正确的扣子ID
5. ✅ 统计页面可以按扣子ID筛选

### 界面验收
1. ✅ 步骤编号正确（1、2、3）
2. ✅ 扣子ID显示清晰
3. ✅ 修改按钮和弹窗交互流畅
4. ✅ 错误提示友好

### 数据验收
1. ✅ .env文件格式正确
2. ✅ 数据库中扣子ID字段正确
3. ✅ 不同扣子ID的数据可以区分