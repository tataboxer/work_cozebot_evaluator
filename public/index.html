<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹å·ç§‘æŠ€é¦†æ•°å­—äººåŠ©æ‰‹è¯„ä¼°å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px 60px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 60px;
            max-width: none;
        }

        .workflow {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .step-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto 20px;
        }

        .step-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .step-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 200px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .file-input {
            margin: 20px 0;
        }

        .file-input input[type="file"] {
            display: none;
        }

        .file-input label {
            background: #f0f0f0;
            color: #333;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .file-input label:hover {
            background: #e0e0e0;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-list select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            border-top: 1px solid #eee;
        }

        /* æ—¥å¿—é¢æ¿æ ·å¼ */
        .log-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 450px;
            height: 80vh;
            max-height: 800px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .log-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }

        .log-header h3 {
            color: #333;
            margin: 0;
            font-size: 1rem;
        }

        .close-log {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6c757d;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.success {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }

        .log-entry.error {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #dc3545;
        }

        .log-entry.info {
            color: #17a2b8;
            background: rgba(23, 162, 184, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #17a2b8;
        }

        .log-entry.python {
            color: #6f42c1;
            background: rgba(111, 66, 193, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #6f42c1;
            font-family: 'Courier New', monospace;
        }

        .log-entry.connected {
            color: #20c997;
            background: rgba(32, 201, 151, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #20c997;
        }

        .log-entry.coze {
            color: #fd7e14;
            background: rgba(253, 126, 20, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #fd7e14;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .log-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 999;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            
            /* æ·»åŠ å±…ä¸­å¯¹é½ */
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .log-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        /* CSVæ˜¾ç¤ºåŒºåŸŸæ ·å¼ */
        .csv-display-section {
            margin-top: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            border: 2px solid #e9ecef;
        }

        .csv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .csv-title {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .csv-header h3 {
            color: #333;
            margin: 0;
            font-size: 1.5rem;
        }

        .csv-filename {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 15px;
            display: inline-block;
            max-width: fit-content;
        }

        .csv-filename.loaded {
            background: #d4edda;
            color: #155724;
        }

        .csv-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .csv-controls label {
            color: #666;
            font-weight: 500;
        }

        .csv-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .csv-content {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #csvTableContainer {
            max-height: 70vh;
            min-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
        }

        #csvTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            table-layout: fixed;
            /* ç¡®ä¿è¡¨æ ¼åœ¨å®¹å™¨ä¸­æ­£ç¡®æ»šåŠ¨ */
            margin: 0;
        }

        #csvTable th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 100;
            user-select: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            /* ç¡®ä¿è¡¨å¤´å†»ç»“æ•ˆæœ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #csvTable th.sortable:hover {
            background: #e9ecef;
        }

        #csvTable th.sortable::after {
            content: 'â‡…';
            float: right;
            opacity: 0.5;
            margin-left: 5px;
        }

        #csvTable th.sortable.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: #007bff;
        }

        #csvTable th.sortable.sort-desc::after {
            content: 'â†“';
            opacity: 1;
            color: #007bff;
        }

        #csvTable td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* åˆ—è°ƒæ•´å™¨æ ·å¼ */
        .column-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
            z-index: 101;
        }

        .column-resizer:hover {
            background: #007bff;
        }

        .column-resizer.resizing {
            background: #007bff;
        }

        /* å•å…ƒæ ¼æ‚¬åœæ˜¾ç¤ºå®Œæ•´å†…å®¹ */
        #csvTable td:hover,
        #csvTable th:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            z-index: 12;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            max-width: 300px;
        }

        #csvTable tr:hover {
            background: #f8f9fa;
        }

        #csvTable tr:nth-child(even) {
            background: #fafafa;
        }

        #csvTable tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        .csv-stats {
            background: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #dee2e6;
            color: #666;
            font-size: 0.9rem;
        }

        /* è¯„ä¼°åˆ†æ•°æ ·å¼ */
        .score-cell {
            text-align: center;
            font-weight: bold;
        }

        .score-5 { color: #28a745; }
        .score-4 { color: #6f9c2f; }
        .score-3 { color: #ffc107; color: #856404; }
        .score-2 { color: #fd7e14; }
        .score-1 { color: #dc3545; }

        /* æ–‡æœ¬æˆªæ–­æ ·å¼ */
        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            position: relative;
            width: 100%;
        }

        .text-truncate:hover {
            background: #e9ecef;
        }

        .text-truncate.expanded {
            white-space: normal;
            max-width: none;
        }

        /* è‡ªé€‚åº”æ–‡æœ¬æ˜¾ç¤º */
        .text-adaptive {
            width: 100%;
            word-wrap: break-word;
            white-space: normal;
            max-height: 150px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .header {
                padding: 30px 20px;
            }

            .main-content {
                padding: 30px 20px;
            }

            .workflow {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .log-panel {
                width: 90vw;
                height: 70vh;
                max-height: 600px;
                right: 5vw;
                left: 5vw;
                top: 15vh;
            }

            .csv-header {
                flex-direction: column;
                align-items: stretch;
            }

            .csv-controls {
                justify-content: center;
            }

            #csvTable {
                font-size: 0.8rem;
            }

            #csvTable th,
            #csvTable td {
                padding: 8px 4px;
            }

            .text-truncate {
                max-width: 120px;
            }

            #csvTableContainer {
                max-height: 60vh;
                min-height: 400px;
            }
        }

        @media (min-width: 1400px) {
            .main-content {
                padding: 80px 100px;
            }

            .header {
                padding: 50px 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– è‹å·ç§‘æŠ€é¦†æ•°å­—äººåŠ©æ‰‹è¯„ä¼°å·¥å…·</h1>
            <p>è‡ªåŠ¨åŒ–æµ‹è¯•å’Œè¯„ä¼°Cozeæ•°å­—äººåŠ©æ‰‹çš„å›å¤è´¨é‡</p>
        </div>

        <div class="main-content">
            <div class="workflow">
                <!-- æ­¥éª¤1: åˆ·æ–°Token -->
                <div class="step-card">
                    <div class="step-number">1</div>
                    <h3>ğŸ”‘ æ‰‹åŠ¨åˆ·æ–°è®¤è¯Token</h3>
                    <p>ä¸šåŠ¡ç³»ç»Ÿå…éªŒè¯ç Tokenå¦‚è¿‡æœŸï¼Œå¯æ‰‹åŠ¨åˆ·æ–°</p>
                    <button id="refreshTokenBtn" class="btn">åˆ·æ–°Token</button>
                    <div id="tokenStatus" class="status"></div>
                </div>

                <!-- æ­¥éª¤2: ä¸Šä¼ Excel -->
                <div class="step-card">
                    <div class="step-number">2</div>
                    <h3>ğŸ“¤ ä¸Šä¼ æµ‹è¯•é—®é¢˜é›†</h3>
                    <p>ä¸Šä¼ Excelæ ¼å¼çš„æµ‹è¯•é—®é¢˜é›†ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è°ƒç”¨Coze Agentç”Ÿæˆå›å¤</p>
                    <div class="file-input">
                        <input type="file" id="excelFile" accept=".xls,.xlsx">
                        <label for="excelFile">é€‰æ‹©Excelæ–‡ä»¶</label>
                        <div id="fileName" style="margin-top: 10px; color: #666;"></div>
                    </div>
                    <button id="processExcelBtn" class="btn" disabled>å¤„ç†Excel</button>
                    <div id="excelStatus" class="status"></div>
                </div>

                <!-- æ­¥éª¤3: æ‰§è¡Œè¯„ä¼° -->
                <div class="step-card">
                    <div class="step-number">3</div>
                    <h3>ğŸ“Š æ‰§è¡Œè´¨é‡è¯„ä¼°</h3>
                    <p>ä½¿ç”¨LLMå¯¹åŠ©æ‰‹å›å¤è¿›è¡Œä¸“ä¸šè¯„ä¼°ï¼Œç”Ÿæˆè¯¦ç»†çš„è´¨é‡æŠ¥å‘Š</p>
                    <div class="file-input">
                        <input type="file" id="assessmentFileInput" accept=".csv">
                        <label for="assessmentFileInput">é€‰æ‹©CSVæ–‡ä»¶</label>
                        <div id="assessmentFileName" style="margin-top: 10px; color: #666;"></div>
                        <div style="margin-top: 5px; font-size: 12px; color: #999;">
                            ğŸ’¡ å»ºè®®é€‰æ‹© data/output/ ç›®å½•ä¸­çš„æ–‡ä»¶
                        </div>
                    </div>
                    <button id="runAssessmentBtn" class="btn" disabled>å¼€å§‹è¯„ä¼°</button>
                    <div id="assessmentStatus" class="status"></div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSVå†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="csvDisplaySection" class="csv-display-section" style="display: none;">
                <div class="csv-header">
                    <div class="csv-title">
                        <h3>ğŸ“‹ ç»“æœé¢„è§ˆ</h3>
                        <div id="csvFileName" class="csv-filename">æœªé€‰æ‹©æ–‡ä»¶</div>
                    </div>
                    <div class="csv-controls">
                        <label for="subtypeFilter">ç­›é€‰ç±»å‹:</label>
                        <select id="subtypeFilter">
                            <option value="all">æ˜¾ç¤ºå…¨éƒ¨</option>
                            <option value="æ–‡æœ¬å›å¤" selected>åªæ˜¾ç¤ºæ–‡æœ¬å›å¤</option>
                        </select>
                        <button id="refreshCsvBtn" class="btn-small">åˆ·æ–°æ•°æ®</button>
                    </div>
                </div>
                <div class="csv-content">
                    <div id="csvTableContainer">
                        <table id="csvTable">
                            <thead id="csvTableHead"></thead>
                            <tbody id="csvTableBody"></tbody>
                        </table>
                    </div>
                    <div id="csvStats" class="csv-stats"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Â© 2025 è‹å·ç§‘æŠ€é¦†æ•°å­—äººåŠ©æ‰‹è¯„ä¼°å·¥å…· | æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘å¤„ç†</p>
        </div>
    </div>

    <!-- æ—¥å¿—é¢æ¿ -->
    <div class="log-toggle" id="logToggle">ğŸ“‹</div>
    <div class="log-panel" id="logPanel">
        <div class="log-header">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <button class="close-log" id="closeLog">&times;</button>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>

    <script>
        // DOM å…ƒç´ 
        const refreshTokenBtn = document.getElementById('refreshTokenBtn');
        const processExcelBtn = document.getElementById('processExcelBtn');
        const runAssessmentBtn = document.getElementById('runAssessmentBtn');
        const excelFileInput = document.getElementById('excelFile');
        const assessmentFileInput = document.getElementById('assessmentFileInput');
        const assessmentFileName = document.getElementById('assessmentFileName');
        const fileName = document.getElementById('fileName');
        const tokenStatus = document.getElementById('tokenStatus');
        const excelStatus = document.getElementById('excelStatus');
        const assessmentStatus = document.getElementById('assessmentStatus');
        const progressFill = document.getElementById('progressFill');
        const progressBar = document.querySelector('.progress-bar');

        // CSVæ˜¾ç¤ºç›¸å…³å…ƒç´ 
        const csvDisplaySection = document.getElementById('csvDisplaySection');
        const csvFileName = document.getElementById('csvFileName');
        const subtypeFilter = document.getElementById('subtypeFilter');
        const refreshCsvBtn = document.getElementById('refreshCsvBtn');
        const csvTable = document.getElementById('csvTable');
        const csvTableHead = document.getElementById('csvTableHead');
        const csvTableBody = document.getElementById('csvTableBody');
        const csvStats = document.getElementById('csvStats');

        // æ—¥å¿—ç›¸å…³å…ƒç´ 
        const logToggle = document.getElementById('logToggle');
        const logPanel = document.getElementById('logPanel');
        const logContent = document.getElementById('logContent');
        const closeLog = document.getElementById('closeLog');

        let logPanelOpen = false;
        let eventSource = null;
        let currentCsvData = null;
        let currentCsvFile = null;

        // æ—¥å¿—åŠŸèƒ½
        logToggle.addEventListener('click', () => {
            logPanelOpen = !logPanelOpen;
            logPanel.style.display = logPanelOpen ? 'flex' : 'none';
            
            // å½“æ—¥å¿—é¢æ¿æ‰“å¼€æ—¶ï¼Œè¿æ¥SSE
            if (logPanelOpen && !eventSource) {
                connectSSE();
            }
        });

        closeLog.addEventListener('click', () => {
            logPanelOpen = false;
            logPanel.style.display = 'none';
        });

        // è¿æ¥Server-Sent Events
        function connectSSE() {
            eventSource = new EventSource('/api/logs');
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addLog(data.type, data.message);
                } catch (error) {
                    console.error('è§£æSSEæ¶ˆæ¯å¤±è´¥:', error);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('SSEè¿æ¥é”™è¯¯:', event);
                // å°è¯•é‡è¿
                setTimeout(() => {
                    if (logPanelOpen) {
                        connectSSE();
                    }
                }, 3000);
            };
        }

        // æ·»åŠ æ—¥å¿—å‡½æ•°
        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            // æ ¹æ®ä¸åŒç±»å‹è®¾ç½®ä¸åŒæ ·å¼
            let icon = '';
            switch(type) {
                case 'success':
                    icon = 'âœ…';
                    break;
                case 'error':
                    icon = 'âŒ';
                    break;
                case 'python':
                    icon = 'ğŸ';
                    break;
                case 'coze':
                    icon = 'ğŸ¤–';
                    break;
                case 'info':
                    icon = 'â„¹ï¸';
                    break;
                case 'connected':
                    icon = 'ğŸ”—';
                    break;
                default:
                    icon = 'ğŸ“';
            }
            
            logEntry.innerHTML = `<strong>[${timestamp}] ${icon}</strong> ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
            if (logContent.children.length > 1000) {
                logContent.removeChild(logContent.firstChild);
            }
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        excelFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = `å·²é€‰æ‹©: ${file.name}`;
                processExcelBtn.disabled = false;
                processExcelBtn.textContent = 'å¤„ç†Excel';
                addLog('info', `æ–‡ä»¶é€‰æ‹©: ${file.name}`);
            } else {
                fileName.textContent = '';
                processExcelBtn.disabled = true;
                addLog('info', 'æ–‡ä»¶é€‰æ‹©å·²å–æ¶ˆ');
            }
        });

        // è¯„ä¼°æ–‡ä»¶é€‰æ‹©
        assessmentFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // æ„å»ºæ–‡ä»¶è·¯å¾„ç”¨äºé¢„è§ˆ
                let csvFilePath;
                if (file.name.startsWith('results_')) {
                    csvFilePath = `data/output/${file.name}`;
                } else {
                    // å¯¹äºéæ ‡å‡†æ–‡ä»¶ï¼Œå…ˆä¸Šä¼ å†é¢„è§ˆ
                    csvFilePath = `data/${file.name}`;
                }
                
                // æ¸…é™¤è‡ªåŠ¨é€‰æ‹©çš„æ–‡ä»¶çŠ¶æ€ï¼Œä½¿ç”¨ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©çš„æ–‡ä»¶
                currentCsvFile = csvFilePath;
                assessmentFileName.textContent = `å·²é€‰æ‹©: ${file.name}`;
                runAssessmentBtn.disabled = false;
                runAssessmentBtn.textContent = 'å¼€å§‹è¯„ä¼°';
                addLog('info', `æ‰‹åŠ¨é€‰æ‹©è¯„ä¼°æ–‡ä»¶: ${file.name}`);
                
                // è‡ªåŠ¨é¢„è§ˆæ‰‹åŠ¨é€‰æ‹©çš„CSVæ–‡ä»¶
                previewCsvFile(csvFilePath, file.name, `æ­£åœ¨é¢„è§ˆé€‰æ‹©çš„CSVæ–‡ä»¶: ${file.name}`);
            } else {
                assessmentFileName.textContent = '';
                runAssessmentBtn.disabled = true;
                addLog('info', 'è¯„ä¼°æ–‡ä»¶é€‰æ‹©å·²å–æ¶ˆ');
                currentCsvFile = null;
            }
        });

        // 1. åˆ·æ–°Token
        refreshTokenBtn.addEventListener('click', async () => {
            addLog('info', 'å¼€å§‹åˆ·æ–°Token...');
            showStatus(tokenStatus, 'info', 'æ­£åœ¨åˆ·æ–°Token...');
            refreshTokenBtn.disabled = true;
            refreshTokenBtn.innerHTML = '<div class="loading"></div>åˆ·æ–°ä¸­...';

            try {
                const response = await fetch('/api/refresh-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(tokenStatus, 'success', 'âœ… Tokenåˆ·æ–°æˆåŠŸï¼');
                    addLog('success', 'Tokenåˆ·æ–°æˆåŠŸ');
                } else {
                    showStatus(tokenStatus, 'error', `âŒ Tokenåˆ·æ–°å¤±è´¥: ${result.message}`);
                    addLog('error', `Tokenåˆ·æ–°å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                showStatus(tokenStatus, 'error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
                addLog('error', `ç½‘ç»œé”™è¯¯: ${error.message}`);
            } finally {
                refreshTokenBtn.disabled = false;
                refreshTokenBtn.textContent = 'åˆ·æ–°Token';
            }
        });

        // 2. å¤„ç†Excel
        processExcelBtn.addEventListener('click', async () => {
            const file = excelFileInput.files[0];
            if (!file) {
                showStatus(excelStatus, 'error', 'âŒ è¯·å…ˆé€‰æ‹©Excelæ–‡ä»¶');
                addLog('error', 'è¯·å…ˆé€‰æ‹©Excelæ–‡ä»¶');
                return;
            }

            addLog('info', 'å¼€å§‹å¤„ç†Excel...');
            showStatus(excelStatus, 'info', 'æ­£åœ¨å¤„ç†Excelæ–‡ä»¶...');
            processExcelBtn.disabled = true;
            processExcelBtn.innerHTML = '<div class="loading"></div>å¤„ç†ä¸­...';

            const formData = new FormData();
            formData.append('excelFile', file);

            try {
                const response = await fetch('/api/process-excel', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(excelStatus, 'success', `âœ… Excelå¤„ç†æˆåŠŸï¼è¾“å‡ºæ–‡ä»¶: ${result.outputFile}`);
                    addLog('success', `Excelå¤„ç†æˆåŠŸ: ${result.outputFile}`);
                    
                    // è‡ªåŠ¨è®¾ç½®ç”Ÿæˆçš„CSVæ–‡ä»¶åˆ°è¯„ä¼°æ–‡ä»¶é€‰æ‹©å™¨
                    const outputFileName = result.outputFile.split('/').pop() || result.outputFile.split('\\').pop();
                    assessmentFileName.textContent = `å·²é€‰æ‹©: ${outputFileName}`;
                    runAssessmentBtn.disabled = false;
                    runAssessmentBtn.textContent = 'å¼€å§‹è¯„ä¼°';
                    addLog('info', `å·²è‡ªåŠ¨é€‰æ‹©ç”Ÿæˆçš„CSVæ–‡ä»¶: ${outputFileName}`);
                    
                    // è‡ªåŠ¨åŠ è½½å’Œé¢„è§ˆCSVæ•°æ®
                    currentCsvFile = result.outputFile;
                    previewCsvFile(result.outputFile, outputFileName, 'æ­£åœ¨é¢„è§ˆç”Ÿæˆçš„CSVæ•°æ®...');
                } else {
                    showStatus(excelStatus, 'error', `âŒ Excelå¤„ç†å¤±è´¥: ${result.message}`);
                    addLog('error', `Excelå¤„ç†å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                showStatus(excelStatus, 'error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
                addLog('error', `ç½‘ç»œé”™è¯¯: ${error.message}`);
            } finally {
                processExcelBtn.disabled = false;
                processExcelBtn.textContent = 'å¤„ç†Excel';
            }
        });

        // 3. æ‰§è¡Œè¯„ä¼°
        runAssessmentBtn.addEventListener('click', async () => {
            let csvFile;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨é€‰æ‹©çš„æ–‡ä»¶ï¼ˆExcelå¤„ç†åï¼‰
            if (currentCsvFile && assessmentFileName.textContent.includes('å·²é€‰æ‹©:')) {
                csvFile = currentCsvFile;
                addLog('info', `ä½¿ç”¨è‡ªåŠ¨é€‰æ‹©çš„æ–‡ä»¶: ${csvFile}`);
            } else {
                // ä½¿ç”¨ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©çš„æ–‡ä»¶
                const file = assessmentFileInput.files[0];
                if (!file) {
                    addLog('error', 'è¯·å…ˆé€‰æ‹©è¦è¯„ä¼°çš„CSVæ–‡ä»¶');
                    return;
                }

                // å‡è®¾ç”¨æˆ·é€‰æ‹©çš„æ˜¯data/outputç›®å½•ä¸­çš„æ–‡ä»¶
                // æ„å»ºæ­£ç¡®çš„æ–‡ä»¶è·¯å¾„
                if (file.name.startsWith('results_')) {
                    csvFile = `data/output/${file.name}`;
                    addLog('info', `ä½¿ç”¨data/outputç›®å½•ä¸­çš„æ–‡ä»¶: ${file.name}`);
                } else {
                    // å¦‚æœä¸æ˜¯æ ‡å‡†æ ¼å¼ï¼Œä¸Šä¼ åˆ°ä¸´æ—¶ç›®å½•å¤„ç†
                    const formData = new FormData();
                    formData.append('csvFile', file);
                    
                    try {
                        const uploadResponse = await fetch('/api/upload-csv', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const uploadResult = await uploadResponse.json();
                        if (!uploadResult.success) {
                            addLog('error', 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + uploadResult.message);
                            return;
                        }
                        
                        csvFile = uploadResult.filePath;
                        addLog('info', `ä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶: ${file.name}`);
                    } catch (uploadError) {
                        addLog('error', 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + uploadError.message);
                        return;
                    }
                }
            }

            addLog('info', 'å¼€å§‹æ‰§è¡Œè¯„ä¼°...');
            showStatus(assessmentStatus, 'info', 'æ­£åœ¨æ‰§è¡Œè¯„ä¼°...');
            runAssessmentBtn.disabled = true;
            runAssessmentBtn.innerHTML = '<div class="loading"></div>è¯„ä¼°ä¸­...';
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            try {
                // æ‰§è¡Œè¯„ä¼°APIè°ƒç”¨
                const response = await fetch('/api/run-assessment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ csvFile })
                });

                const result = await response.json();

                if (result.success) {
                    addLog('success', 'è¯„ä¼°å®Œæˆï¼');
                    showStatus(assessmentStatus, 'success', 'âœ… è¯„ä¼°å®Œæˆ');
                    progressFill.style.width = '100%';
                    
                    // è¯„ä¼°å®Œæˆååˆ·æ–°CSVé¢„è§ˆï¼ˆæ˜¾ç¤ºåŒ…å«è¯„ä¼°ç»“æœçš„æ•°æ®ï¼‰
                    const fileName = csvFile.split('/').pop() || csvFile.split('\\').pop();
                    previewCsvFile(csvFile, fileName, 'æ­£åœ¨åˆ·æ–°è¯„ä¼°ç»“æœé¢„è§ˆ...');
                } else {
                    addLog('error', 'è¯„ä¼°å¤±è´¥: ' + result.message);
                    showStatus(assessmentStatus, 'error', 'âŒ è¯„ä¼°å¤±è´¥');
                }

            } catch (error) {
                addLog('error', 'è¯„ä¼°è¯·æ±‚å¤±è´¥: ' + error.message);
                showStatus(assessmentStatus, 'error', 'âŒ è¯„ä¼°è¯·æ±‚å¤±è´¥');
            } finally {
                runAssessmentBtn.disabled = false;
                runAssessmentBtn.textContent = 'å¼€å§‹è¯„ä¼°';
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 2000);
            }
        });


        // è¿™ä¸ªå‡½æ•°å·²ç»ä¸å†éœ€è¦ï¼Œå› ä¸ºç°åœ¨ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(element, type, message) {
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';

            // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // è‡ªåŠ¨è¿æ¥SSEä»¥æ¥æ”¶å®æ—¶æ—¥å¿—
            connectSSE();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†SSEè¿æ¥
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        });

        // ä¸å†éœ€è¦å®šæœŸåˆ·æ–°æ–‡ä»¶åˆ—è¡¨ï¼Œå› ä¸ºç°åœ¨ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨

        // ç»Ÿä¸€çš„CSVé¢„è§ˆå‡½æ•°
        function previewCsvFile(filePath, fileName, logMessage) {
            if (!filePath) return;
            
            setTimeout(() => {
                loadCsvData(filePath);
                addLog('info', logMessage || `æ­£åœ¨é¢„è§ˆCSVæ–‡ä»¶: ${fileName}`);
            }, 500);
        }

        // CSVæ•°æ®ç›¸å…³å‡½æ•°
        async function loadCsvData(csvFile) {
            try {
                addLog('info', `æ­£åœ¨åŠ è½½CSVæ•°æ®: ${csvFile}`);
                const url = `/api/csv-data?file=${encodeURIComponent(csvFile)}`;
                console.log('è¯·æ±‚URL:', url);
                
                const response = await fetch(url);
                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
                
                // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                console.log('å“åº”ç±»å‹:', contentType);
                
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('éJSONå“åº”:', textResponse.substring(0, 200));
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”');
                }
                
                const result = await response.json();
                console.log('è§£æç»“æœ:', result);
                
                if (result.success) {
                    currentCsvData = result.data;
                    displayCsvData(currentCsvData);
                    csvDisplaySection.style.display = 'block';
                    
                    // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
                    const fileName = csvFile.split('/').pop() || csvFile; // æå–æ–‡ä»¶å
                    csvFileName.textContent = `ğŸ“ ${fileName}`;
                    csvFileName.className = 'csv-filename loaded';
                    
                    addLog('success', `CSVæ•°æ®åŠ è½½æˆåŠŸï¼Œå…± ${result.data.length} è¡Œ`);
                } else {
                    addLog('error', `CSVæ•°æ®åŠ è½½å¤±è´¥: ${result.message}`);
                    console.error('æœåŠ¡å™¨é”™è¯¯:', result.error);
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    csvFileName.textContent = 'âŒ åŠ è½½å¤±è´¥';
                    csvFileName.className = 'csv-filename';
                }
            } catch (error) {
                console.error('åŠ è½½CSVæ•°æ®å®Œæ•´é”™è¯¯:', error);
                addLog('error', `åŠ è½½CSVæ•°æ®æ—¶å‡ºé”™: ${error.message}`);
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                csvFileName.textContent = 'âŒ åŠ è½½å‡ºé”™';
                csvFileName.className = 'csv-filename';
                
                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('Unexpected token')) {
                    addLog('error', 'æœåŠ¡å™¨å¯èƒ½è¿”å›äº†HTMLè€Œä¸æ˜¯JSONï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
                }
            }
        }

        function displayCsvData(data) {
            if (!data || data.length === 0) {
                csvTableBody.innerHTML = '<tr><td colspan="100%">æš‚æ— æ•°æ®</td></tr>';
                csvStats.innerHTML = 'æš‚æ— æ•°æ®';
                return;
            }

            // åº”ç”¨è¿‡æ»¤å™¨
            const filterValue = subtypeFilter.value;
            let filteredData = data;
            
            if (filterValue !== 'all') {
                filteredData = data.filter(row => row.block_subtype === filterValue);
            }

            // åˆ›å»ºè¡¨å¤´
            if (data.length > 0) {
                const columns = Object.keys(data[0]);
                csvTableHead.innerHTML = `
                    <tr>
                        ${columns.map((col, index) => {
                            const isSortable = isSortableColumn(col);
                            return `
                                <th style="width: ${getColumnWidth(col)}px;" 
                                    class="${isSortable ? 'sortable' : ''}"
                                    data-column="${col}"
                                    data-sort="none">
                                    ${col}
                                    <div class="column-resizer" data-column="${index}"></div>
                                </th>
                            `;
                        }).join('')}
                    </tr>
                `;
                
                // æ·»åŠ åˆ—è°ƒæ•´äº‹ä»¶ç›‘å¬å™¨
                initColumnResizers();
                
                // æ·»åŠ æ’åºäº‹ä»¶ç›‘å¬å™¨
                initColumnSorting();
            }

            // åˆ›å»ºè¡¨æ ¼å†…å®¹
            renderTableBody(filteredData);

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateCsvStats(data, filteredData);
        }

        function updateCsvStats(allData, filteredData) {
            const totalRows = allData.length;
            const filteredRows = filteredData.length;
            const answerRows = filteredData.filter(row => row.block_type === 'answer').length;
            const textReplyRows = filteredData.filter(row => row.block_subtype === 'æ–‡æœ¬å›å¤').length;
            
            // è®¡ç®—è¯„ä¼°å®Œæˆæƒ…å†µ
            const evaluatedRows = filteredData.filter(row => 
                row['æœ€ç»ˆå‡†ç¡®ç‡_åˆ†æ•°'] && row['ä¸“ä¸šåº¦_åˆ†æ•°'] && row['è¯­æ°”åˆç†_åˆ†æ•°']
            ).length;
            
            // è®¡ç®—å¹³å‡åˆ†æ•°
            const scores = {
                accuracy: [],
                professionalism: [],
                tone: []
            };
            
            filteredData.forEach(row => {
                if (row['æœ€ç»ˆå‡†ç¡®ç‡_åˆ†æ•°']) scores.accuracy.push(parseFloat(row['æœ€ç»ˆå‡†ç¡®ç‡_åˆ†æ•°']));
                if (row['ä¸“ä¸šåº¦_åˆ†æ•°']) scores.professionalism.push(parseFloat(row['ä¸“ä¸šåº¦_åˆ†æ•°']));
                if (row['è¯­æ°”åˆç†_åˆ†æ•°']) scores.tone.push(parseFloat(row['è¯­æ°”åˆç†_åˆ†æ•°']));
            });
            
            const avgAccuracy = scores.accuracy.length ? (scores.accuracy.reduce((a, b) => a + b, 0) / scores.accuracy.length).toFixed(2) : 'N/A';
            const avgProfessionalism = scores.professionalism.length ? (scores.professionalism.reduce((a, b) => a + b, 0) / scores.professionalism.length).toFixed(2) : 'N/A';
            const avgTone = scores.tone.length ? (scores.tone.reduce((a, b) => a + b, 0) / scores.tone.length).toFixed(2) : 'N/A';
            
            // è®¡ç®—é¦–tokenæ—¶é•¿ç»Ÿè®¡
            const tokenTimes = [];
            filteredData.forEach(row => {
                const blockStart = parseFloat(row.block_start);
                if (!isNaN(blockStart) && blockStart > 0) {
                    tokenTimes.push(blockStart);
                }
            });
            
            let tokenStats = 'N/A';
            if (tokenTimes.length > 0) {
                const avgTokenTime = (tokenTimes.reduce((a, b) => a + b, 0) / tokenTimes.length).toFixed(2);
                const minTokenTime = Math.min(...tokenTimes).toFixed(2);
                const maxTokenTime = Math.max(...tokenTimes).toFixed(2);
                tokenStats = `å¹³å‡${avgTokenTime}s (${minTokenTime}s~${maxTokenTime}s)`;
            }
            
            // è®¡ç®—æ€»æ—¶é•¿ç»Ÿè®¡ï¼ˆblock_end - block_startï¼‰
            const totalDurations = [];
            filteredData.forEach(row => {
                const blockStart = parseFloat(row.block_start);
                const blockEnd = parseFloat(row.block_end);
                if (!isNaN(blockStart) && !isNaN(blockEnd) && blockEnd > blockStart) {
                    totalDurations.push(blockEnd - blockStart);
                }
            });
            
            let durationStats = 'N/A';
            if (totalDurations.length > 0) {
                const avgDuration = (totalDurations.reduce((a, b) => a + b, 0) / totalDurations.length).toFixed(2);
                const minDuration = Math.min(...totalDurations).toFixed(2);
                const maxDuration = Math.max(...totalDurations).toFixed(2);
                durationStats = `å¹³å‡${avgDuration}s (${minDuration}s~${maxDuration}s)`;
            }
            
            csvStats.innerHTML = `
                <strong>æ•°æ®ç»Ÿè®¡:</strong> 
                æ€»è¡Œæ•°: ${totalRows} | 
                æ˜¾ç¤ºè¡Œæ•°: ${filteredRows} | 
                å›ç­”ç±»å‹: ${answerRows} | 
                æ–‡æœ¬å›å¤: ${textReplyRows} | 
                å·²è¯„ä¼°: ${evaluatedRows}/${answerRows} | 
                <strong>é¦–Tokenæ—¶é•¿:</strong> ${tokenStats} | 
                <strong>æ®µæ—¶é•¿:</strong> ${durationStats} | 
                <strong>å¹³å‡åˆ†æ•°:</strong> 
                å‡†ç¡®ç‡: ${avgAccuracy} | 
                ä¸“ä¸šåº¦: ${avgProfessionalism} | 
                è¯­æ°”: ${avgTone}
            `;
        }

        // æ–‡æœ¬å±•å¼€/æ”¶èµ·åŠŸèƒ½
        function toggleText(element) {
            element.classList.toggle('expanded');
        }

        // è·å–åˆ—çš„é»˜è®¤å®½åº¦
        function getColumnWidth(columnName) {
            const widthMap = {
                'question_id': 40,
                'question_type': 60,
                'question_text': 220,
                'context': 150,
                'chatid': 50,
                'block_type': 50,
                'block_subtype': 80,
                'block_result': 500,  // å¢åŠ å›ç­”å†…å®¹åˆ—çš„é»˜è®¤å®½åº¦
                'block_start': 55,
                'block_end': 55,
                'æœ€ç»ˆå‡†ç¡®ç‡_åˆ†æ•°': 80,
                'æœ€ç»ˆå‡†ç¡®ç‡_ç†ç”±': 150,  // å¢åŠ è¯„ä¼°ç†ç”±åˆ—çš„é»˜è®¤å®½åº¦
                'ä¸“ä¸šåº¦_åˆ†æ•°': 80,
                'ä¸“ä¸šåº¦_ç†ç”±': 150,     // å¢åŠ è¯„ä¼°ç†ç”±åˆ—çš„é»˜è®¤å®½åº¦
                'è¯­æ°”åˆç†_åˆ†æ•°': 80,
                'è¯­æ°”åˆç†_ç†ç”±': 150    // å¢åŠ è¯„ä¼°ç†ç”±åˆ—çš„é»˜è®¤å®½åº¦
            };
            return widthMap[columnName] || 150; // é»˜è®¤å®½åº¦
        }

        // åˆ¤æ–­åˆ—æ˜¯å¦å¯æ’åº
        function isSortableColumn(columnName) {
            const sortableColumns = [
                'block_start',
                'block_end', 
                'æœ€ç»ˆå‡†ç¡®ç‡_åˆ†æ•°',
                'ä¸“ä¸šåº¦_åˆ†æ•°',
                'è¯­æ°”åˆç†_åˆ†æ•°'
            ];
            return sortableColumns.includes(columnName);
        }

        // åˆå§‹åŒ–åˆ—æ’åºåŠŸèƒ½
        function initColumnSorting() {
            const sortableHeaders = csvTableHead.querySelectorAll('th.sortable');
            
            sortableHeaders.forEach(header => {
                header.addEventListener('click', (e) => {
                    // é˜»æ­¢ç‚¹å‡»è°ƒæ•´å™¨æ—¶çš„æ’åº
                    if (e.target.classList.contains('column-resizer')) {
                        return;
                    }
                    
                    const columnName = header.dataset.column;
                    const currentSort = header.dataset.sort;
                    
                    // æ¸…é™¤å…¶ä»–åˆ—çš„æ’åºçŠ¶æ€
                    sortableHeaders.forEach(h => {
                        if (h !== header) {
                            h.dataset.sort = 'none';
                            h.classList.remove('sort-asc', 'sort-desc');
                        }
                    });
                    
                    // åˆ‡æ¢å½“å‰åˆ—çš„æ’åºçŠ¶æ€
                    let newSort;
                    if (currentSort === 'none' || currentSort === 'desc') {
                        newSort = 'asc';
                    } else {
                        newSort = 'desc';
                    }
                    
                    header.dataset.sort = newSort;
                    header.classList.remove('sort-asc', 'sort-desc');
                    header.classList.add(`sort-${newSort}`);
                    
                    // æ‰§è¡Œæ’åº
                    sortTableData(columnName, newSort);
                    
                    addLog('info', `æŒ‰ ${columnName} åˆ—è¿›è¡Œ${newSort === 'asc' ? 'å‡åº' : 'é™åº'}æ’åº`);
                });
            });
        }

        // æ’åºè¡¨æ ¼æ•°æ®
        function sortTableData(columnName, direction) {
            if (!currentCsvData || currentCsvData.length === 0) return;
            
            // åº”ç”¨è¿‡æ»¤å™¨
            const filterValue = subtypeFilter.value;
            let filteredData = [...currentCsvData];
            
            if (filterValue !== 'all') {
                filteredData = currentCsvData.filter(row => row.block_subtype === filterValue);
            }
            
            // æ’åºæ•°æ®
            filteredData.sort((a, b) => {
                let valueA = a[columnName];
                let valueB = b[columnName];
                
                // å¤„ç†æ•°å€¼ç±»å‹
                if (columnName === 'block_start' || columnName === 'block_end' || 
                    columnName.includes('_åˆ†æ•°')) {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                }
                
                // å¤„ç†ç©ºå€¼
                if (valueA === null || valueA === undefined || valueA === '') valueA = direction === 'asc' ? Infinity : -Infinity;
                if (valueB === null || valueB === undefined || valueB === '') valueB = direction === 'asc' ? Infinity : -Infinity;
                
                if (direction === 'asc') {
                    return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
                } else {
                    return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
                }
            });
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼å†…å®¹ï¼ˆåªé‡æ–°æ¸²æŸ“tbodyï¼Œä¿æŒè¡¨å¤´ä¸å˜ï¼‰
            renderTableBody(filteredData);
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateCsvStats(currentCsvData, filteredData);
        }

        // æ¸²æŸ“è¡¨æ ¼ä¸»ä½“
        function renderTableBody(data) {
            csvTableBody.innerHTML = data.map(row => {
                const cells = Object.keys(row).map(key => {
                    let value = row[key] || '';
                    let cellClass = '';
                    
                    // ä¸ºè¯„ä¼°åˆ†æ•°åˆ—æ·»åŠ é¢œè‰²æ ·å¼
                    if (key.includes('_åˆ†æ•°') && value) {
                        cellClass = `score-cell score-${value}`;
                    }
                    
                    // è½¬æ¢æ¢è¡Œç¬¦è½¬ä¹‰å­—ç¬¦ä¸ºHTMLæ¢è¡Œ
                    if (typeof value === 'string') {
                        // å¤„ç†CSVä¸­çš„åŒåæ–œæ è½¬ä¹‰ï¼š\\n -> <br>
                        value = value.replace(/\\\\n/g, '<br>');
                        
                        // ç‰¹æ®Šå¤„ç†contextåˆ—ï¼šæ ¼å¼åŒ–JSONæ˜¾ç¤º
                        if (key === 'context' && value && value.trim() && value !== '<br>') {
                            try {
                                // ç°åœ¨contextåº”è¯¥æ˜¯æ ‡å‡†JSONæ•°ç»„æ ¼å¼
                                const jsonData = JSON.parse(value.replace(/<br>/g, '\n'));
                                
                                if (Array.isArray(jsonData) && jsonData.length > 0) {
                                    // æ ¼å¼åŒ–ä¸ºå¯è¯»çš„å¯¹è¯å†å²
                                    const formatted = jsonData.map((msg, index) => {
                                        const role = msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                                        const content = msg.content || '';
                                        return `${index + 1}. ${role}: ${content}`;
                                    }).join('<br>');
                                    value = formatted;
                                }
                            } catch (e) {
                                // è§£æå¤±è´¥æ—¶ä¿æŒåŸæ ·
                                console.warn('Contextè§£æå¤±è´¥:', e);
                            }
                        }
                    }
                    
                    // ä¸ºé•¿æ–‡æœ¬æ·»åŠ åˆé€‚çš„æ˜¾ç¤ºæ ·å¼
                    if (typeof value === 'string' && value.replace(/<br>/g, '\n').length > 50) {
                        // å¯¹äºç‰¹å®šçš„é•¿æ–‡æœ¬åˆ—ï¼Œä½¿ç”¨è‡ªé€‚åº”æ˜¾ç¤º
                        if (key === 'block_result' || key.includes('_ç†ç”±')) {
                            return `<td class="${cellClass}"><div class="text-adaptive" title="å†…å®¹è¾ƒé•¿ï¼Œå·²è‡ªåŠ¨æ¢è¡Œ">${value}</div></td>`;
                        } else {
                            return `<td class="${cellClass}"><div class="text-truncate" onclick="toggleText(this)" title="ç‚¹å‡»å±•å¼€/æ”¶èµ·">${value}</div></td>`;
                        }
                    }
                    
                    return `<td class="${cellClass}">${value}</td>`;
                }).join('');
                
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        // åˆå§‹åŒ–åˆ—è°ƒæ•´å™¨
        function initColumnResizers() {
            const resizers = document.querySelectorAll('.column-resizer');
            let isResizing = false;
            let currentResizer = null;
            let startX = 0;
            let startWidth = 0;

            resizers.forEach(resizer => {
                resizer.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    currentResizer = resizer;
                    startX = e.clientX;
                    
                    const columnIndex = parseInt(resizer.dataset.column);
                    const th = csvTableHead.querySelector(`th:nth-child(${columnIndex + 1})`);
                    startWidth = th.offsetWidth;
                    
                    resizer.classList.add('resizing');
                    document.body.style.cursor = 'col-resize';
                    
                    e.preventDefault();
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing || !currentResizer) return;
                
                const diff = e.clientX - startX;
                const newWidth = Math.max(50, startWidth + diff); // æœ€å°å®½åº¦50px
                
                const columnIndex = parseInt(currentResizer.dataset.column);
                const th = csvTableHead.querySelector(`th:nth-child(${columnIndex + 1})`);
                
                if (th) {
                    th.style.width = newWidth + 'px';
                    
                    // åŒæ—¶æ›´æ–°æ‰€æœ‰ç›¸åº”çš„td
                    const rows = csvTableBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const td = row.querySelector(`td:nth-child(${columnIndex + 1})`);
                        if (td) {
                            td.style.width = newWidth + 'px';
                        }
                    });
                }
                
                e.preventDefault();
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    if (currentResizer) {
                        currentResizer.classList.remove('resizing');
                        currentResizer = null;
                    }
                    document.body.style.cursor = 'default';
                }
            });
        }

        // è¿‡æ»¤å™¨äº‹ä»¶ç›‘å¬
        subtypeFilter.addEventListener('change', () => {
            if (currentCsvData) {
                displayCsvData(currentCsvData);
            }
        });

        // åˆ·æ–°CSVæ•°æ®æŒ‰é’®
        refreshCsvBtn.addEventListener('click', () => {
            if (currentCsvFile) {
                loadCsvData(currentCsvFile);
            }
        });
    </script>
</body>
</html>