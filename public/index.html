<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>苏州科技馆数字人助手评估工具</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- 访问密钥验证弹窗 -->
    <div class="access-modal" id="accessModal" style="display: none;">
        <div class="access-modal-content">
            <h3>🔐 访问验证</h3>
            <p>请输入访问密钥以使用本平台</p>
            <input type="password" class="access-input" id="accessInput" placeholder="请输入访问密钥" onkeypress="if(event.key==='Enter') window.app.verifyAccess()">
            <div class="access-buttons">
                <button class="access-btn access-btn-primary" id="submitAccessBtn" onclick="window.app.verifyAccess()">验证</button>
            </div>
            <div id="accessError" class="access-error"></div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>🏛️ 苏州科技馆 AI 助手评估平台</h1>
            <p>自动化测试和评估Coze数字人助手的回复质量</p>
            
            <!-- 导航栏 -->
            <div class="navigation">
                <button class="nav-btn active" onclick="showPage('data-processing')">数据处理</button>
                <button class="nav-btn" onclick="showPage('records')">记录查询</button>
                <button class="nav-btn" onclick="showPage('statistics')">统计分析</button>
                <button class="nav-btn" onclick="showPage('evaluators')">评估器管理</button>
            </div>
        </div>

        <div class="main-content">
            <!-- 数据处理页面 -->
            <div id="dataProcessingPage" class="page-content">
                <div class="workflow">
                    <!-- 步骤1: 上传Excel -->
                    <div class="step-card">
                        <div class="step-number">1</div>
                        <h3>上传测试问题集</h3>
                        <p>上传测试集（<a href="templates/test_set_example.xls" download>下载样例</a>），自动调用Coze Agent生成回复</p>
                        <div class="file-input">
                            <input type="file" id="excelFile" accept=".xls,.xlsx">
                            <label for="excelFile">选择Excel文件</label>
                            <div id="fileName" style="margin-top: 10px; color: #666;"></div>
                        </div>
                        <button id="processExcelBtn" class="btn" disabled>处理Excel</button>
                        <div id="excelStatus" class="status"></div>
                        <div class="progress-container">
                            <div id="excelProgressText" class="progress-text"></div>
                            <div class="progress-bar" id="excelProgressBar">
                                <div class="progress-fill" id="excelProgressFill"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 步骤2: 执行评估 -->
                    <div class="step-card">
                        <div class="step-number">2</div>
                        <h3>执行质量评估</h3>
                        <p>使用LLM对助手回复进行专业评估，生成详细的质量报告</p>
                        <div id="assessmentFileName" style="margin: 10px 0 25px 0; color: #666;">请先完成第1步Excel处理</div>
                        <button id="runAssessmentBtn" class="btn" disabled>开始评估</button>
                        <div id="assessmentStatus" class="status"></div>
                        <div class="progress-container">
                            <div id="progressText" class="progress-text"></div>
                            <div class="progress-bar" id="progressBar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CSV内容显示区域 -->
                <div id="csvDisplaySection" class="csv-display-section" style="display: none;">
                    <div class="csv-header">
                        <div class="csv-title">
                            <h3>结果预览</h3>
                            <div id="csvFileName" class="csv-filename">未选择文件</div>
                        </div>
                        <div class="csv-controls">
                            <label for="questionTypeFilter">问题类型:</label>
                            <select id="questionTypeFilter">
                                <option value="all">显示全部</option>
                            </select>

                            <label for="subtypeFilter">筛选类型:</label>
                            <select id="subtypeFilter">
                                <option value="all">显示全部</option>
                                <option value="文本回复" selected>只显示文本回复</option>
                            </select>

                            <button id="downloadCsvBtn" class="btn-small" disabled>下载CSV</button>
                        </div>
                    </div>
                    <div class="csv-content">
                        <div id="csvTableContainer">
                            <table id="csvTable">
                                <thead id="csvTableHead"></thead>
                                <tbody id="csvTableBody"></tbody>
                            </table>
                        </div>
                        <div id="csvStats" class="csv-stats"></div>
                    </div>
                </div>
            </div>

            <!-- 记录查询页面 -->
            <div id="recordsPage" class="page-content" style="display: none;">
                <div class="records-container">
                    <div class="search-filters">
                        <input type="date" id="startDate" placeholder="开始日期">
                        <input type="date" id="endDate" placeholder="结束日期">
                        <input type="text" id="sessionNameFilter" placeholder="会话名称">
                        <select id="pageSizeSelect" onchange="changePageSize()">
                            <option value="10" selected>每页 10 条</option>
                            <option value="20">每页 20 条</option>
                            <option value="50">每页 50 条</option>
                        </select>
                        <button class="btn-small" onclick="searchSessions()">🔍 搜索</button>
                        <button class="btn-small" id="batchDeleteBtn" onclick="batchDeleteSessions()" style="background: #dc3545; display: none;">🗑️ 批量删除</button>
                    </div>

                    <div class="sessions-list">
                        <div class="table-container">
                            <table class="sessions-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)"></th>
                                        <th>会话名称</th>
                                        <th>创建时间</th>
                                        <th>问题数量</th>
                                        <th>平均准确率</th>
                                        <th>平均专业度</th>
                                        <th>平均语气</th>
                                        <th>首Token平均</th>
                                        <th>首Token最小</th>
                                        <th>首Token最高</th>
                                        <th>平均段时长</th>
                                        <th>配置信息</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="sessionsTableBody">
                                    <!-- 动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="pagination">
                        <button onclick="prevPage()">上一页</button>
                        <span id="pageInfo">第 1 页，共 1 页</span>
                        <button onclick="nextPage()">下一页</button>
                    </div>
                </div>
            </div>

            <!-- 统计分析页面 -->
            <div id="statisticsPage" class="page-content" style="display: none;">
                <div class="placeholder-content">
                    <h2>📊 统计分析</h2>
                    <p>功能开发中，敬请期待...</p>
                </div>
            </div>

            <!-- 评估器管理页面 -->
            <div id="evaluatorsPage" class="page-content" style="display: none;">
                <div class="placeholder-content">
                    <h2>🔧 评估器管理</h2>
                    <p>功能开发中，敬请期待...</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© 2025 苏州科技馆数字人助手评估工具 | 支持多线程并发处理</p>
        </div>
    </div>

    <!-- 日志面板 -->
    <div class="log-toggle" id="logToggle">LOG</div>
    <div class="log-panel" id="logPanel">
        <div class="log-header">
            <h3>操作日志</h3>
            <button class="close-log" id="closeLog">&times;</button>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>

    <!-- 会话详情弹窗 -->
    <div class="session-detail-modal" id="sessionDetailModal" style="display: none;">
        <div class="session-modal-content">
            <div class="modal-header">
                <h3>📋 评估详情 - <span id="modalSessionName"></span></h3>
                <button class="close-modal" onclick="closeSessionDetail()">&times;</button>
            </div>
            


            <div class="modal-results-section">
                <div class="csv-header">
                    <div class="csv-title">
                        <h4>📊 详细结果</h4>
                    </div>
                    <div class="csv-controls">
                        <label for="modalQuestionTypeFilter">问题类型:</label>
                        <select id="modalQuestionTypeFilter">
                            <option value="all">显示全部</option>
                        </select>
                        
                        <label for="modalSubtypeFilter">筛选类型:</label>
                        <select id="modalSubtypeFilter">
                            <option value="all">显示全部</option>
                            <option value="文本回复" selected>只显示文本回复</option>
                        </select>
                        
                        <button class="btn-small" onclick="exportSessionData()">📥 导出CSV</button>
                    </div>
                </div>
                
                <div class="csv-content">
                    <div id="modalTableContainer">
                        <table id="modalTable">
                            <thead id="modalTableHead"></thead>
                            <tbody id="modalTableBody"></tbody>
                        </table>
                    </div>
                    <div id="modalStats" class="csv-stats"></div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-small" onclick="deleteSessionFromModal()" style="background: #dc3545;">🗑️ 删除会话</button>
                <button class="btn" onclick="closeSessionDetail()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 主应用架构 -->
    <script src="js/simple-list-renderer.js?v=3.0"></script>
    <script src="js/data-manager.js?v=3.0"></script>
    <script src="js/app.js?v=3.0"></script>
    <script src="js/navigation.js"></script>
    <script src="js/session-modal.js"></script>
</body>
</html>